<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Unity Web Player | ColorMaze</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico" />
    <link rel="stylesheet" href="TemplateData/style.css" />
    <link rel="manifest" href="manifest.webmanifest" />

    <style>
      /* --- Reset / base --- */
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        background: black;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      #unity-container {
        position: relative;
        width: 100%;
        height: 100%;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background: black;
      }

      #unity-canvas {
        display: block;
        background: #000;
        max-width: 100%;
        max-height: 100%;
        box-shadow: 0 6px 30px rgba(0,0,0,0.6);
        border-radius: 6px;
      }

      #unity-loading-bar {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 60%;
        max-width: 600px;
        display: none;
        z-index: 50;
      }
      #unity-loading-bar #unity-progress-bar-empty {
        width: 100%;
        height: 6px;
        background: rgba(255,255,255,0.12);
        border-radius: 6px;
        overflow: hidden;
      }
      #unity-progress-bar-full {
        height: 100%;
        width: 0%;
        background: linear-gradient(90deg, #47a7ff, #7c4dff);
      }

      #unity-warning {
        position: absolute;
        left: 12px;
        right: 12px;
        top: 12px;
        z-index: 60;
        pointer-events: none;
        display: none;
      }

      /* Rotate overlay for mobile landscape */
      #rotate-overlay {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        pointer-events: auto;
      }
      #rotate-overlay .backdrop {
        position: absolute;
        inset: 0;
        background: rgba(0,0,0,0.6);
        backdrop-filter: blur(6px);
      }
      #rotate-overlay .message {
        position: relative;
        color: #fff;
        text-align: center;
        padding: 28px 24px;
        max-width: 420px;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.6);
        background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
        border: 1px solid rgba(255,255,255,0.06);
        transform: translateY(-6px);
      }
      #rotate-overlay .icon { font-size: 46px; margin-bottom: 10px; display:block; filter: drop-shadow(0 2px 6px rgba(0,0,0,0.6)); }
      #rotate-overlay .title { font-weight:700; font-size:20px; margin-bottom:6px; }
      #rotate-overlay .subtitle { font-size:14px; opacity:0.9; line-height:1.3; }

      @media (max-width: 420px) {
        #rotate-overlay .message { padding: 20px; max-width: 320px; border-radius: 12px; }
        #rotate-overlay .icon { font-size: 40px; }
      }
    </style>
  </head>
  <body>
    <div id="unity-container">
      <canvas id="unity-canvas" width="960" height="600" tabindex="-1"></canvas>

      <div id="unity-loading-bar">
        <div id="unity-logo"></div>
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
      </div>

      <div id="unity-warning"> </div>
    </div>

    <div id="rotate-overlay" aria-hidden="true">
      <div class="backdrop"></div>
      <div class="message" role="alert" aria-live="assertive">
        <div class="icon">ðŸ“±ðŸ”’</div>
        <div class="title">Please rotate your device</div>
        <div class="subtitle">This game is best played in <strong>portrait</strong>. Rotate your phone back to continue.</div>
      </div>
    </div>

    <script>
      /* =========================================================
         CONFIG: update these if your Build folder filenames differ
         ========================================================= */
      var buildUrl = "Build";
      // IMPORTANT: change these filenames to match what is actually in your Build folder.
      // I used your earlier filenames with spaces "New folder.*" â€” if your files differ, update here.
      var expectedFiles = [
        { key: "loader", url: buildUrl + "/New folder.loader.js" },
        { key: "data", url: buildUrl + "/New folder.data.unityweb" },
        { key: "framework", url: buildUrl + "/New folder.framework.js.unityweb" },
        { key: "wasm", url: buildUrl + "/New folder.wasm.unityweb" }
      ];

      // Unity create config (ensure dataUrl/framework/code match your Build files)
      var config = {
        arguments: [],
        dataUrl: buildUrl + "/New folder.data.unityweb",
        frameworkUrl: buildUrl + "/New folder.framework.js.unityweb",
        codeUrl: buildUrl + "/New folder.wasm.unityweb",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "LovedeepSinghGame",
        productName: "ColorMaze",
        productVersion: "0.1.0",
        showBanner: unityShowBanner
      };

      /* =========================================================
         DOM refs
         ========================================================= */
      var container = document.querySelector("#unity-container");
      var canvas = document.querySelector("#unity-canvas");
      var loadingBar = document.querySelector("#unity-loading-bar");
      var progressBarFull = document.querySelector("#unity-progress-bar-full");
      var warningBanner = document.querySelector("#unity-warning");
      var rotateOverlay = document.getElementById("rotate-overlay");

      /* =========================================================
         Utility: show an on-page banner (info/warn/error)
         ========================================================= */
      function showPageMessage(text, level) {
        // level: "error", "warn", "info"
        var container = document.querySelector("#unity-warning");
        var div = document.createElement("div");
        div.style.padding = "10px";
        div.style.margin = "6px";
        div.style.borderRadius = "6px";
        div.style.color = "#fff";
        div.style.fontFamily = "system-ui, Arial, sans-serif";
        if (level === "error") {
          div.style.background = "linear-gradient(90deg, #ff5f5f, #ff2f2f)";
        } else if (level === "warn") {
          div.style.background = "linear-gradient(90deg,#ffb86b,#ff8c3a)";
        } else {
          div.style.background = "rgba(255,255,255,0.06)";
        }
        div.textContent = text;
        container.appendChild(div);
        container.style.display = "block";
      }

      function clearPageMessages() {
        var container = document.querySelector("#unity-warning");
        container.innerHTML = "";
        container.style.display = "none";
      }

      /* =========================================================
         Device detection & layout behavior
         ========================================================= */
      var isMobileUA = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      var isSmallScreen = window.matchMedia("(max-width: 900px)").matches;
      var isMobile = isMobileUA || isSmallScreen;

      // Add viewport meta for true mobile sizing
      if (isMobileUA) {
        var meta = document.createElement('meta');
        meta.name = 'viewport';
        meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
        document.getElementsByTagName('head')[0].appendChild(meta);
      }

      function applyPcLayout() {
        container.style.background = "black";
        var targetW = 1080;
        var targetH = 1920;
        var vw = window.innerWidth;
        var vh = window.innerHeight;
        var scale = Math.min(vw / targetW, vh / targetH, 1);
        var cssW = Math.round(targetW * scale);
        var cssH = Math.round(targetH * scale);
        canvas.style.width = cssW + "px";
        canvas.style.height = cssH + "px";
        canvas.style.maxWidth = "100%";
        canvas.style.maxHeight = "100%";
        // set canvas pixel resolution using devicePixelRatio for crispness
        var dpr = window.devicePixelRatio || 1;
        canvas.width = Math.round(targetW * dpr);
        canvas.height = Math.round(targetH * dpr);
        document.body.style.background = "black";
      }

      function applyMobileLayout() {
        container.style.background = "black";
        canvas.style.width = "100vw";
        canvas.style.height = "100vh";
        canvas.style.maxWidth = "100%";
        canvas.style.maxHeight = "100%";
        canvas.style.borderRadius = "0";
        var dpr = window.devicePixelRatio || 1;
        var w = Math.max(window.innerWidth, 1);
        var h = Math.max(window.innerHeight, 1);
        canvas.width = Math.round(w * dpr);
        canvas.height = Math.round(h * dpr);
        document.body.style.background = "black";
      }

      function applyLayout() {
        // refresh mobile detection by viewport
        isMobile = isMobileUA || window.matchMedia("(max-width: 900px)").matches;
        if (isMobile) applyMobileLayout();
        else applyPcLayout();
      }

      // determine portrait by window dims
      function isPortrait() { return window.innerHeight >= window.innerWidth; }

      function showRotateOverlay(show) {
        if (!isMobile) {
          rotateOverlay.style.display = "none";
          rotateOverlay.setAttribute("aria-hidden", "true");
          return;
        }
        if (show) {
          rotateOverlay.style.display = "flex";
          rotateOverlay.setAttribute("aria-hidden", "false");
          canvas.style.pointerEvents = "none";
        } else {
          rotateOverlay.style.display = "none";
          rotateOverlay.setAttribute("aria-hidden", "true");
          canvas.style.pointerEvents = "auto";
        }
      }

      function onResizeOrRotate() {
        isMobile = isMobileUA || window.matchMedia("(max-width: 900px)").matches;
        applyLayout();
        if (isMobile && !isPortrait()) showRotateOverlay(true);
        else showRotateOverlay(false);
      }

      window.addEventListener("orientationchange", onResizeOrRotate);
      window.addEventListener("resize", onResizeOrRotate);
      setTimeout(onResizeOrRotate, 200);

      /* =========================================================
         Loader with robust checks + helpful messages
         ========================================================= */

      // Unregister service workers to avoid stale caching issues during debug
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function(regs) {
          regs.forEach(function(r) {
            try { r.unregister(); console.log("ServiceWorker unregistered:", r); } catch(e){}
          });
        }).catch(function(e){});
      }

      // Check file availability (HEAD then fallback to GET)
      function checkFilesExist(fileList, timeoutMs) {
        timeoutMs = timeoutMs || 7000;
        var checks = fileList.map(function(f) {
          return new Promise(function(resolve) {
            var controller = new AbortController();
            var signal = controller.signal;
            fetch(f.url, { method: "HEAD", signal: signal }).then(function(resp) {
              resolve({ key: f.key, url: f.url, ok: resp.ok, status: resp.status, contentType: resp.headers.get("content-type") });
            }).catch(function() {
              fetch(f.url, { method: "GET", signal: signal }).then(function(resp2) {
                resolve({ key: f.key, url: f.url, ok: resp2.ok, status: resp2.status, contentType: resp2.headers.get("content-type") });
              }).catch(function(err) {
                resolve({ key: f.key, url: f.url, ok: false, status: (err && err.message) || "network-error" });
              });
            });
            setTimeout(function(){ controller.abort(); }, timeoutMs);
          });
        });
        return Promise.all(checks);
      }

      // Provide a friendly unityShowBanner used by Unity (kept for compatibility)
      function unityShowBanner(msg, type) {
        // show simple banner using the same warning area
        showPageMessage(msg, type === "error" ? "error" : "info");
      }

      // Main async loader
      (async function runLoaderChecksAndStart() {
        clearPageMessages();
        showPageMessage("Checking build files...", "info");
        console.log("Checking build files:", expectedFiles);

        try {
          var results = await checkFilesExist(expectedFiles, 7000);
        } catch (e) {
          console.error("Error while checking files:", e);
          showPageMessage("Error while checking build files: " + e.message, "error");
          return;
        }
        console.log("File existence results:", results);

        var missing = results.filter(r => !r.ok || (typeof r.ok === "undefined" && r.status !== 200));
        if (missing.length) {
          missing.forEach(function(m) {
            showPageMessage("Build file not accessible: " + m.url + " (status: " + m.status + " content-type: " + (m.contentType || "unknown") + ")", "error");
          });
          showPageMessage("Common causes: wrong filename/path, served via file:// (use http), CORS, or wrong MIME types for .wasm. Check DevTools Network tab.", "warn");
          console.error("Missing/failed files:", missing);
          return;
        }

        // All looked OK -> load loader script
        try {
          showPageMessage("All build files found. Loading Unity loader...", "info");
          var loaderUrl = expectedFiles.find(x=>x.key==="loader").url;
          var script = document.createElement("script");
          script.src = loaderUrl;
          script.onload = function() {
            showPageMessage("Loader script loaded. Creating Unity instance...", "info");
            try {
              // Optionally control matchWebGLToCanvasSize in config here
              // config.matchWebGLToCanvasSize = false;
              createUnityInstance(canvas, config, function(progress) {
                try { progressBarFull.style.width = 100 * progress + "%"; } catch(e){}
              }).then(function(instance) {
                showPageMessage("Unity instance created.", "info");
                loadingBar.style.display = "none";
                console.log("Unity instance:", instance);
              }).catch(function(err) {
                console.error("createUnityInstance failed:", err);
                showPageMessage("ERROR: createUnityInstance failed. See console for details.", "error");
                showPageMessage(String(err), "error");
              });
            } catch (ex) {
              console.error("Exception while creating Unity instance:", ex);
              showPageMessage("Exception creating Unity instance: " + ex.message, "error");
            }
          };
          script.onerror = function(e) {
            console.error("Failed to load loader script:", loaderUrl, e);
            showPageMessage("Failed to load loader script: " + loaderUrl, "error");
          };
          document.body.appendChild(script);
        } catch (e) {
          console.error("Error injecting loader script:", e);
          showPageMessage("Error injecting loader script: " + e.message, "error");
        }
      })();

      // Expose helper to let Unity call JS to force a layout recalculation
      window.__recalculateCanvasLayout = function() {
        onResizeOrRotate();
      };

    </script>
  </body>
</html>
